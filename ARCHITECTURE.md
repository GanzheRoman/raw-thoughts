# 🏗 Архитектура RawThoughts Bot

## 📊 Схема работы системы

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Пользователь  │    │   Модератор     │    │     Канал       │
│                 │    │                 │    │                 │
│ 1. /start       │    │ 3. Получает     │    │ 5. Публикация   │
│ 2. Отправляет   │───▶│    уведомление  │───▶│    проблемы     │
│    проблему     │    │ 4. ✅/❌        │    │ 6. 👍 Лайки     │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │                       │
         ▼                       ▼                       ▼
┌─────────────────────────────────────────────────────────────────┐
│                    Google Sheets                               │
│  ┌─────────┬─────────────┬─────────┬─────────┬─────────────────┐ │
│  │   ID    │    Текст    │ Лайки   │ Статус  │ Дата создания   │ │
│  ├─────────┼─────────────┼─────────┼─────────┼─────────────────┤ │
│  │    1    │ Проблема... │    5    │approved │ 2024-01-01      │ │
│  │    2    │ Проблема... │    0    │pending  │ 2024-01-01      │ │
│  └─────────┴─────────────┴─────────┴─────────┴─────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
```

## 🔄 Поток данных

### 1. Пользователь отправляет проблему
```
Пользователь → user.py → GoogleSheetsService → Google Sheets
                ↓
         moderation.py → Модераторский чат
```

### 2. Модерация
```
Модератор → moderation.py → GoogleSheetsService → Google Sheets
                ↓
         channel.py → Канал (если одобрено)
```

### 3. Голосование
```
Пользователь → channel.py → GoogleSheetsService → Google Sheets
                ↓
         Обновление сообщения в канале
```

## 📁 Структура файлов

```
rawthoughts-bot/
├── main.py                    # 🚀 Точка входа
├── requirements.txt           # 📦 Зависимости
├── .env                       # 🔐 Конфигурация
├── credentials.json           # 🔑 Google API ключи
├── bot.log                   # 📝 Логи
│
├── handlers/                  # 🎯 Обработчики сообщений
│   ├── user.py               # 👤 Пользователи
│   ├── moderation.py         # 👮 Модерация
│   └── channel.py            # 📺 Канал
│
├── services/                  # 🔧 Сервисы
│   └── google_sheets.py      # 📊 Google Sheets API
│
└── utils/                     # 🛠 Утилиты
    └── get_ids.py            # 🆔 Получение ID
```

## 🔧 Компоненты системы

### 1. **main.py** - Основной модуль
- Инициализация бота и диспетчера
- Регистрация роутеров
- Настройка сервисов
- Запуск polling

### 2. **handlers/user.py** - Пользовательские сообщения
- Команда `/start`
- Обработка текстовых сообщений
- Валидация входных данных
- Сохранение в Google Sheets

### 3. **handlers/moderation.py** - Модерация
- Отправка уведомлений модераторам
- Обработка кнопок "✅ Одобрить" / "❌ Отклонить"
- Публикация в канал
- Статистика модерации

### 4. **handlers/channel.py** - Работа с каналом
- Обработка лайков
- Обновление сообщений
- Форматирование для канала

### 5. **services/google_sheets.py** - Google Sheets API
- Подключение к Google Sheets
- CRUD операции
- Создание заголовков
- Получение статистики

## 🔄 Жизненный цикл проблемы

```
1. Создание
   Пользователь → user.py → GoogleSheetsService.add_problem()
   Статус: "pending"

2. Модерация
   moderation.py → send_to_moderators()
   Модератор → approve_problem() / reject_problem()
   Статус: "approved" / "rejected"

3. Публикация (если одобрено)
   moderation.py → publish_to_channel()
   Канал получает сообщение с кнопкой лайка

4. Голосование
   Пользователь → channel.py → handle_like()
   GoogleSheetsService.update_likes()
   Обновление сообщения в канале
```

## 🛡 Безопасность

- **Переменные окружения**: Все секреты в `.env`
- **Google API**: Service Account с ограниченными правами
- **Telegram**: Бот работает только в разрешенных чатах
- **Валидация**: Проверка всех входящих данных

## 📈 Масштабируемость

### Горизонтальное масштабирование
- Несколько экземпляров бота
- Общая база данных (Google Sheets)
- Stateless архитектура

### Вертикальное масштабирование
- Кэширование данных
- Асинхронная обработка
- Оптимизация запросов к Google Sheets

## 🔮 Возможные улучшения

1. **База данных**: Замена Google Sheets на PostgreSQL
2. **Кэширование**: Redis для быстрого доступа
3. **Очереди**: Celery для фоновых задач
4. **Мониторинг**: Prometheus + Grafana
5. **Логирование**: ELK Stack
6. **Тестирование**: pytest + coverage
